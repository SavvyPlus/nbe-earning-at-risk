AWSTemplateFormatVersion: 2010-09-09
Description: 'Template to build code pipeline, build and deploy lambdas from github'
Parameters:
  ArtifactBucket:
    Type: String
    Default: empower-pipeline-bucket
    Description: Name of existing S3 bucket for storing pipeline artifacts
  GitHubOwner:
    Type: String
    Default: SavvyPlus
    Description: GitHub Repository Owner
  GitHubRepo:
    Type: String
    Default: nbe-earning-at-risk
    Description: GitHub repo name
  GitHubBranch:
    Type: String
    Default: master
    Description: GitHub repo branch
  GitHubToken:
    Type: String
    Description: GitHub repo OAuth token
  PipelineName:
    Type: String
    Description: Name of the pipeline to create
    Default: nbe-earning-at-risk
  Email:
    Description: The email address where CodePipeline sends pipeline notifications
    Default: weiliang.zhou@zawee.work
    Type: String
  BucketName:
    Description: Bukcet Name
    Default: nbe-earning-at-risk-
    Type: String
  ProdStackName:
    Default: nbe-earning-at-risk-prod-stk
    Description: A name for the production stack
    Type: String
  ProdStackConfig:
    Default: prod-nbe-earning-at-risk-stack-configuration.json
    Description: The configuration file name for the production stack
    Type: String
  ChangeSetName:
    Default: UpdateNBEEarningAtRiskStack
    Description: A name for the production nbe-earning-at-risk stack change set
    Type: String

Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: CodePipeline Settings
        Parameters:
          - PipelineName
          - Email
  'AWS::CloudFormation::Designer':
    8afa232b-5a79-4ed4-91e8-57c50221ceba:
      size:
        width: 60
        height: 60
      position:
        x: 170
        'y': 80
      z: 1
      embeds: []

Resources:
  CFNRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service:
                - cloudformation.amazonaws.com
        Version: 2012-10-17
      Path: /
      Policies:
        - PolicyName: CloudFormationRole
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Action: '*'
                Effect: Allow
                Resource: '*'
  PipelineRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action:
              - 'sts:AssumeRole'
            Effect: Allow
            Principal:
              Service:
                - codepipeline.amazonaws.com
        Version: 2012-10-17
      Path: /
      Policies:
        - PolicyName: CodePipelineAccess
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Action:
                  - 's3:*'
                  - 'cloudformation:CreateStack'
                  - 'cloudformation:DescribeStacks'
                  - 'cloudformation:DeleteStack'
                  - 'cloudformation:UpdateStack'
                  - 'cloudformation:CreateChangeSet'
                  - 'cloudformation:ExecuteChangeSet'
                  - 'cloudformation:DeleteChangeSet'
                  - 'cloudformation:DescribeChangeSet'
                  - 'cloudformation:SetStackPolicy'
                  - 'codebuild:StartBuild'
                  - 'codebuild:BatchGetBuilds'
                  - 'iam:PassRole'
                  - 'sns:Publish'
                Effect: Allow
                Resource: '*'
  CloudFormationRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - 'sts:AssumeRole'
            Principal:
              Service:
                - cloudformation.amazonaws.com
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AdministratorAccess'
  CodeBuildRole:
    Type: 'AWS::IAM::Role'
    DependsOn: CloudFormationRole
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - 'sts:AssumeRole'
            Principal:
              Service:
                - codebuild.amazonaws.com
      Policies:
        - PolicyName: ServiceRole
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: CloudWatchWriteLogsPolicy
                Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource: '*'
              - Sid: S3GetObjectPolicy
                Effect: Allow
                Action:
                  - 's3:GetObject'
                  - 's3:GetObjectVersion'
                Resource: '*'
              - Sid: S3PutObjectPolicy
                Effect: Allow
                Action:
                  - 's3:PutObject'
                Resource: '*'
  CodePipelineSNSTopic:
    Type: 'AWS::SNS::Topic'
    Properties:
      Subscription:
        - Endpoint: !Ref Email
          Protocol: email

  CodeBuildProcessTradeDataLambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildProcessTradeDataLambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: NBE_process_trade_data/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  CodeBuildEarningAtRiskLambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildEarningAtRiskLambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: NBE_EarningAtRisk/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  CodeBuildCheckEARSummaryOutputLambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildCheckEARSummaryOutputLambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: NBE_check_ear_summary_output_by_sim/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  CodeBuildGetPercentileOutputsLambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildGetPercentileOutputsLambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: NBE_get_percentile_outputs/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  CodeBuildEARHHTracesLambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildEARHHTracesLambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: NBE_EAR_HH_Traces/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  CodeBuildSendOutputsLambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildSendOutputsLambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: NBE_send_outputs_via_emails/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  CodeBuildCreateBucketNBELambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildCreateBucketNBELambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: create-bucket/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  CodeBuildSimulateHistoryLambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildSimulateHistoryLambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: NBE_simulate_history/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  CodeBuildSimulateCustomerDataLambda:
    Type: 'AWS::CodeBuild::Project'
    DependsOn: CloudFormationRole
    Properties:
      Artifacts:
        Type: CODEPIPELINE
      Environment:
        ComputeType: BUILD_GENERAL1_SMALL
        Image: 'aws/codebuild/python:3.6.5'
        Type: LINUX_CONTAINER
      Name: CodeBuildSimulateCustomerDataLambda
      ServiceRole: !GetAtt
        - CodeBuildRole
        - Arn
      Source:
        Type: CODEPIPELINE
        BuildSpec: NBE_simulate_customer_data/buildspec.yaml
      TimeoutInMinutes: 5
      Cache:
        Location: empower-build-cache
        Type: S3

  Pipeline:
    Type: 'AWS::CodePipeline::Pipeline'
    Properties:
      RoleArn: !GetAtt [PipelineRole, Arn]
      ArtifactStore:
        Type: S3
        Location: !Ref ArtifactBucket
      Name: !Ref PipelineName
      Stages:
        - Name: GitHubSource
          Actions:
            - Name: TemplateSource
              ActionTypeId:
                Category: Source
                Owner: ThirdParty
                Version: 1
                Provider: GitHub
              Configuration:
                Owner: !Ref GitHubOwner
                Repo: !Ref GitHubRepo
                Branch: !Ref GitHubBranch
                OAuthToken: !Ref GitHubToken
              OutputArtifacts:
                - Name: SourceCode
              RunOrder: 1

        - Name: BuildNBELambdas
          Actions:
            - Name: BuildProcessTradeDataLambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildProcessTradeDataLambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildProcessTradeDataLambdaOutput
            - Name: BuildEarningAtRiskLambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildEarningAtRiskLambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildEarningAtRiskLambdaOutput
            - Name: BuildCheckEARSummaryOutputLambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildCheckEARSummaryOutputLambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildCheckEARSummaryOutputLambda
            - Name: BuildGetPercentileOutputsLambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildGetPercentileOutputsLambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildGetPercentileOutputsLambdaOutput
            - Name: BuildEARHHTracesLambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildEARHHTracesLambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildEARHHTracesLambdaOutput
            - Name: BuildSendOutputsLambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildSendOutputsLambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildSendOutputsLambdaOutput
            - Name: BuildCreateBucketNBELambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildCreateBucketNBELambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildCreateBucketNBELambdaOutput
            - Name: BuildSimulateHistoryLambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildSimulateHistoryLambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildSimulateHistoryLambdaOutput
            - Name: BuildSimulateCustomerDataLambda
              ActionTypeId:
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              Configuration:
                ProjectName: !Ref CodeBuildSimulateCustomerDataLambda
              InputArtifacts:
                - Name: SourceCode
              OutputArtifacts:
                - Name: BuildSimulateCustomerDataLambdaOutput


        - Name: ProdStage
          Actions:
            - Name: CreateChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              InputArtifacts:
                - Name: SourceCode
                - Name: BuildProcessTradeDataLambdaOutput
                - Name: BuildEarningAtRiskLambdaOutput
                - Name: BuildCheckEARSummaryOutputLambda
                - Name: BuildGetPercentileOutputsLambdaOutput
                - Name: BuildEARHHTracesLambdaOutput
                - Name: BuildSendOutputsLambdaOutput
                - Name: BuildCreateBucketNBELambdaOutput
                - Name: BuildSimulateHistoryLambdaOutput
                - Name: BuildSimulateCustomerDataLambdaOutput
              Configuration:
                ActionMode: CHANGE_SET_REPLACE
                RoleArn: !GetAtt [CFNRole, Arn]
                StackName: !Ref ProdStackName
                Capabilities: CAPABILITY_NAMED_IAM
                ChangeSetName: !Ref ChangeSetName
                TemplateConfiguration: !Sub 'SourceCode::cloudformation/config/${ProdStackConfig}'
                TemplatePath: 'SourceCode::cloudformation/lambda.cfn.yaml'
                ParameterOverrides: !Sub |
                  {
                    "ProcessTradeDataK": {"Fn::GetArtifactAtt":["BuildProcessTradeDataLambdaOutput", "ObjectKey"]},
                    "EarningAtRiskK": {"Fn::GetArtifactAtt":["BuildEarningAtRiskLambdaOutput", "ObjectKey"]},
                    "CheckEARSummaryOutputK": {"Fn::GetArtifactAtt":["BuildCheckEARSummaryOutputLambda", "ObjectKey"]},
                    "GetPercentileK": {"Fn::GetArtifactAtt":["BuildGetPercentileOutputsLambdaOutput", "ObjectKey"]},
                    "EARHHTracesK": {"Fn::GetArtifactAtt":["BuildEARHHTracesLambdaOutput", "ObjectKey"]},
                    "SendOutputsK": {"Fn::GetArtifactAtt":["BuildSendOutputsLambdaOutput", "ObjectKey"]},
                    "CreateBucketNBEK": {"Fn::GetArtifactAtt":["BuildCreateBucketNBELambdaOutput", "ObjectKey"]},
                    "SimulateHistoryK": {"Fn::GetArtifactAtt":["BuildSimulateHistoryLambdaOutput", "ObjectKey"]},
                    "SimulateCustomerDataK": {"Fn::GetArtifactAtt":["BuildSimulateCustomerDataLambdaOutput", "ObjectKey"]},
                    "BucketName": "${BucketName}"
                  }
              RunOrder: '1'

            - Name: ApproveChangeSet
              ActionTypeId:
                Category: Approval
                Owner: AWS
                Provider: Manual
                Version: '1'
              Configuration:
                NotificationArn: !Ref CodePipelineSNSTopic
                CustomData: !Sub >-
                  A new change set was created for the ${ProdStackName} stack.
                  Do you want to implement the changes?
              RunOrder: '2'

            - Name: ExecuteChangeSet
              ActionTypeId:
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: '1'
              Configuration:
                ActionMode: CHANGE_SET_EXECUTE
                ChangeSetName: !Ref ChangeSetName
                RoleArn: !GetAtt [CFNRole, Arn]
                StackName: !Ref ProdStackName
              RunOrder: '3'


Outputs:
  ArtifactBucket:
    Description: S3 bucket holding all the OutputArtifacts of any pipeline stage
    Value: !Ref ArtifactBucket
    Export:
      Name: NBEEarningAtRiskArtifactsBucket
